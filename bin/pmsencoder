#!/usr/bin/env perl

use strict;
use warnings;

use App::PMSEncoder;

# FIXME: this still accepts -test &c. Plough through the
# hundreds of alternatives to find something that DWIM

use Getopt::Long qw(:config posix_default no_ignore_case); 

$| = 1; # unbuffer output

my ($test, $version);

GetOptions(
    'test:s'  => \$test,
    'version' => \$version,
) || die "can't process options";

my $pmsencoder = App::PMSEncoder->new();

if (defined $test) {
    my @args = $pmsencoder->get_resource('test_args.txt');

    if (length $test) {
	$pmsencoder->fatal('if supplied, the argument to --test must be a valid URI') unless ($test =~ m{^\w+://});
	$args[0] = $test;
    }
    $pmsencoder->argv(\@args);
} else {
    $pmsencoder->argv(\@ARGV);
}

if ($version) {
    $pmsencoder->version();
} else {
    $pmsencoder->run();
}
